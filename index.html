let capitalInicial = 0;
let egresoInicial = 0;
let capitalNeto = 0;
let totalGastos = 0;
const gastos = [];
let nextGastoId = 1;

function cambiarFondo() {
    const seleccion = document.getElementById('colorFondo').value;
    const root = document.documentElement.style;
    
    if (seleccion === 'negro') {
        root.setProperty('--body-bg', '#000000');
        root.setProperty('--text-color', '#ffffff');
        root.setProperty('--container-bg', '#222222');
        root.setProperty('--gastos-list-bg', '#2e2e2e');
        root.setProperty('--li-bg', '#444444');
        root.setProperty('--summary-bg', '#1c1c1c');
    } else {
        root.setProperty('--body-bg', '#f0f4f7');
        root.setProperty('--text-color', '#333');
        root.setProperty('--container-bg', '#fff');
        root.setProperty('--gastos-list-bg', '#fff');
        root.setProperty('--li-bg', '#f5f5f5');
        root.setProperty('--summary-bg', '#e8f0fe');
    }
}

// Función para guardar los datos en localStorage
function guardarDatos() {
    localStorage.setItem('capitalInicial', capitalInicial);
    localStorage.setItem('egresoInicial', egresoInicial);
    localStorage.setItem('totalGastos', totalGastos);
    localStorage.setItem('gastos', JSON.stringify(gastos));
}

// Función para recuperar los datos del localStorage
function cargarDatos() {
    const capitalGuardado = parseFloat(localStorage.getItem('capitalInicial')) || 0;
    const egresoGuardado = parseFloat(localStorage.getItem('egresoInicial')) || 0;
    const totalGastosGuardado = parseFloat(localStorage.getItem('totalGastos')) || 0;
    const gastosGuardados = JSON.parse(localStorage.getItem('gastos')) || [];

    capitalInicial = capitalGuardado;
    egresoInicial = egresoGuardado;
    totalGastos = totalGastosGuardado;
    gastos.length = 0;  // Limpiar el array actual
    gastos.push(...gastosGuardados);

    calcularCapital(); // Para actualizar la visualización al cargar los datos
    renderizarGastos(); // Para renderizar los gastos guardados
}

// Función para calcular el capital neto
function calcularCapital() {
    capitalNeto = capitalInicial - egresoInicial - totalGastos;
    actualizarResultadoCapital();
    guardarDatos(); // Guardamos los cambios después de calcular
}

// Función para actualizar el resultado del capital
function actualizarResultadoCapital() {
    const resultadoCapitalElement = document.getElementById('resultadoCapital');
    resultadoCapitalElement.innerHTML = `Dinero Neto: ${formatearMoneda(capitalNeto)} COP`;
    if (capitalNeto < 0) {
        resultadoCapitalElement.classList.add('deficit');
    } else {
        resultadoCapitalElement.classList.remove('deficit');
    }
}

// Función para agregar un gasto
function agregarGasto() {
    const monto = parseFloat(document.getElementById('montoGasto').value) || 0;
    const descripcion = document.getElementById('descripcionGasto').value.trim();
    const categoria = document.getElementById('categoriaGasto').value;

    if (monto <= 0 || descripcion === '' || categoria === '') {
        alert('⚠️ Por favor, pon un monto, una descripción y un tipo de gasto.');
        return;
    }

    const nuevoGasto = {
        id: nextGastoId++,
        monto: monto,
        descripcion: descripcion,
        categoria: categoria
    };

    gastos.push(nuevoGasto);
    totalGastos += monto;
    capitalNeto -= monto;

    renderizarGastos(); 
    document.getElementById('montoGasto').value = '';
    document.getElementById('descripcionGasto').value = '';
    document.getElementById('categoriaGasto').value = 'Sin Categoría';
    actualizarTotalGastos();
    actualizarResultadoCapital();
    guardarDatos(); // Guardamos los datos después de agregar el gasto
}

// Función para eliminar un gasto
function eliminarGasto(idGasto) {
    const index = gastos.findIndex(gasto => gasto.id === idGasto);

    if (index !== -1) {
        const montoEliminado = gastos[index].monto;

        capitalNeto += montoEliminado;
        totalGastos -= montoEliminado;

        gastos.splice(index, 1);

        renderizarGastos();
        actualizarTotalGastos();
        actualizarResultadoCapital();
        guardarDatos(); // Guardamos los datos después de eliminar el gasto
    }
}

// Función para limpiar todos los gastos
function limpiarGastos() {
    if (confirm('¿Seguro que quieres borrar TODOS los gastos? No podrás recuperarlos.')) {
        capitalNeto += totalGastos;

        gastos.length = 0;
        totalGastos = 0;

        renderizarGastos();
        actualizarTotalGastos();
        actualizarResultadoCapital();
        guardarDatos(); // Guardamos los datos después de limpiar
    }
}

// Función para renderizar los gastos
function renderizarGastos() {
    const gastosLista = document.getElementById('gastosLista');
    const filtroSeleccionado = document.getElementById('filtroGasto').value;
    gastosLista.innerHTML = '';

    const gastosFiltrados = gastos.filter(gasto => 
        filtroSeleccionado === 'Todos' || gasto.categoria === filtroSeleccionado
    );

    if (gastosFiltrados.length === 0) {
        const li = document.createElement('li');
        li.style.borderLeft = '5px solid #ff9800';
        li.textContent = filtroSeleccionado === 'Todos' ? 'No hay gastos todavía.' : `No hay gastos de ${filtroSeleccionado}.`;
        gastosLista.appendChild(li);
    }

    gastosFiltrados.forEach(gasto => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>
                <span class="category-tag">${gasto.categoria}</span> 
                ${gasto.descripcion}: <strong>${formatearMoneda(gasto.monto)} COP</strong>
            </span>
            <button class="delete-btn" onclick="eliminarGasto(${gasto.id})">Borrar</button>
        `;
        gastosLista.appendChild(li);
    });

    generarResumenCategorias();
}

// Función para generar resumen por categorías
function generarResumenCategorias() {
    const resumenContainer = document.getElementById('resumenCategorias');
    let resumenHTML = '<h4>Total por Tipo de Gasto</h4>';
    
    const totales = gastos.reduce((acc, gasto) => {
        acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.monto;
        return acc;
    }, {});

    for (const categoria in totales) {
        resumenHTML += `<div><span>${categoria}:</span> <strong>${formatearMoneda(totales[categoria])} COP</strong></div>`;
    }

    resumenContainer.innerHTML = resumenHTML;
}

// Función para actualizar el total de los gastos
function actualizarTotalGastos() {
    const totalGastosElement = document.getElementById('totalGastos');
    totalGastosElement.textContent = `Total Gastado: ${formatearMoneda(totalGastos)} COP`;
}

// Función para formatear la moneda
function formatearMoneda(valor) {
    return valor.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Cargar los datos al inicio
cargarDatos(); // Esta función recupera los datos guardados en localStorage al cargar la página

